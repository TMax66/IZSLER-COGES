---
title: "Attività 2019 - definizione dei tempi analisi"
author: " "
date: "11/11/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library("readxl")
library("tidyverse")
library("lubridate")
library("kableExtra")
library("gridExtra")
library("hrbrthemes")
library("knitr")
library("here")
library("patchwork")

###TEMPI ANALISI###
tempi <- read_excel(here("programmazione", "data", "raw", "newtempianalisi.xlsx"))
tempi$mp <- substr(tempi$VALORI_MP_REV, start=1, stop = 9)
tempi$VNMP <- paste(tempi$VALORI_VN,tempi$mp, tempi$VALORI_REVISIONE) # <- creo una chiave univoca in tempi tempi$VNMPdup <- duplicated(tempi$VNMP)


###ESAMI 2019 DARWIN###
esami <- read_excel(here("programmazione", "data", "raw", "dati2019.xlsx"))


###esami singoli
esami <- esami %>% 
  filter(is.na(provagruppi))

esami$MMPP <- substr(esami$mp, start=1, stop = 9)

esami$VNMP <- paste(esami$vn, esami$MMPP, esami$revmp) # <- creo chiave simile a tempi$VNMP per fare collegamento tra esami e tempi

esami$REPARTO <- tolower(esami$Reparto)

esami <- esami %>% 
  mutate(REPARTO = recode(REPARTO, "sede territoriale di milano (is)" = "sede territoriale di milano", 
                          "reparto tecnologie biologiche applicate - batteriologia specializzata" = "reparto tecnologie biologiche applicate", 
                          "reparto tecnologie biologiche applicate - colture cellulari" = "reparto tecnologie biologiche applicate", 
                          "reparto virologia - laboratorio proteomica" = "reparto virologia", 
                          )) %>% 
  filter(!REPARTO %in% c("analisi del rischio ed epidemiologia genomica",
                         "reparto produzione e controllo materiale biologico"))



## esami gruppi####

gruppi <- read_excel(here("programmazione", "data", "raw", "dati2019Gruppi.xlsx"))
gruppi$MMPP <- substr(gruppi$`Descrizione del MP`, start=1, stop = 9)
gruppi$VNMP <- paste(gruppi$`Chiave VN Gruppo`, gruppi$MMPP, gruppi$`Revisione del MP`)
gruppi$REPARTO <- tolower(gruppi$`Reparto che esegue le analisi`)

gruppi <- gruppi %>% 
  mutate(REPARTO = recode(REPARTO,  
                          "reparto tecnologie biologiche applicate - batteriologia specializzata" = "reparto tecnologie biologiche applicate")) %>% 
  filter(!REPARTO %in% c("reparto produzione e controllo materiale biologico"))


Gruppi <-  gruppi %>% 
  group_by(REPARTO, VNMP, 
          dtreg = `Data di registrazione`) %>% 
  summarise(esami = n()) 


###gruppi+singoli

Esami <- esami %>% 
  select(REPARTO, VNMP, dtreg, esami) %>% 
  union ( (Gruppi %>% 
             select(REPARTO,VNMP, dtreg, esami )) )


#### Ore lavorate 2019###  GRU
hwd19 <- readRDS( here("programmazione", "data", "processed", "hwd19.rds")) # <- dati ore contratto e ore erogate per dip/rep/lab

hwd19$REPARTO <- tolower(hwd19$Laboratorio)

hwd19 <- hwd19 %>% 
  mutate(REPARTO = recode(REPARTO, "sede territoriale di piacenza - parma" = "sede territoriale di piacenza" , 
                          "laboratorio chimica applicata alle tecnologie alimentari" = "reparto chimica degli alimenti e mangimi",
                          "laboratorio contaminanti ambientali" = "reparto chimica degli alimenti e mangimi", 
                          "laboratorio mangimi e tossicologia" = "reparto chimica degli alimenti e mangimi", 
                          "laboratorio residui" = "reparto chimica degli alimenti e mangimi", 
                          "reparto chimico degli alimenti (bologna)" = "bologna (reparto chimico degli alimenti)", 
                          "laboratorio analisi genomiche, laboratorio diagnostica molecolare, ogm" = "reparto tecnologie biologiche applicate",
                          "laboratorio batteriologia specializzata" = "reparto tecnologie biologiche applicate", 
                          "laboratorio colture cellulari, biobanca" = "reparto tecnologie biologiche applicate", 
                          "laboratorio di proteomica e diagnostica tse" = "reparto virologia", 
                          "laboratorio di virologia e sierologia specializzata, microscopia elettronica" = "reparto virologia")) %>% 
  filter(!REPARTO %in% c("laboratorio benessere animale, biochimica clinica, immunologia veterinaria e stabulari",
                         "laboratorio di controllo di prodotti biologici, farmaceutici e convalida di processi produttivi", 
                         "laboratorio produzione terreni", 
                         "laboratorio produzione vaccini e reagenti"))

```

### Distribuzione tempi-analisi

Ci sono complessivamente 1605 Voci Nomenclatore associati a differenti tempi-analisi cosi come sono stati calcolati per la valorizzazione. La Mediana è pari a 16 minuti. 



```{r echo=FALSE, message=FALSE, warning=FALSE}

m <- median(tempi$MinutiComparto, na.rm = TRUE)

p1 <- tempi %>% 
ggplot(aes(MinutiComparto)) +
  geom_histogram(bins = 100, alpha=0.5)+
  theme_ipsum_rc()+
  labs(x="")+
  geom_vline(xintercept = m, color = "red")+
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())
  


p2 <- tempi %>% 
  ggplot(aes( MinutiComparto, y = 1))+
  geom_jitter(aes(), alpha=0.2, position=position_jitter(w=0.1,h=0.1))+
  theme_ipsum_rc()+
  geom_vline(xintercept = m, color = "red")+
  labs(x="")+
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())

p1/p2 + plot_annotation("Distribuzione dei tempi analisi in minuti di 1605 VN")

```

### Definizione tempi analisi per Reparto

A partire dal database delle valorizzazioni utilizzando la chiave-analisi VNMP ( VN+MP+rev)  è stato possibile collegarsi al database derivato da Darwin degli esami eseguiti nel 2019. Per ogni chiave-analisi il numero di esami eseguiti per reparto è stato moltiplicato per il tempo-esame, ottenendo quindi il tempo-analisi.

Per gli esami appartenenti a gruppi-analisi, il calcolo del numero di analisi è basato sul conferimento, in quanto gli esami effettuati per ogni gruppo analisi ha lo stesso tempo-analisi del data-base valorizzazioni, in quanto è stato valorizzato per singolo gruppo. Quindi il tempo analisi è definito dalla moltiplicazione del numero di analisi di gruppo definito dalla VN specifica  per il corrispondente tempo-analisi della VN.

A titolo di esempio  due tabelle:  
La tabella 1 riporta per la data del 7/1/2019 del reparto **Sede Territoriale di Bergamo**, le prove eseguite e corrispondente VNMP, il numero di esami eseguiti per singola VNMP, il tempo esame definito e il tempo-analisi (tempo esame X n.esami)


```{r echo=FALSE, message=FALSE, warning=FALSE}


 options(knitr.kable.NA = '')
esami %>% 
    left_join((tempi %>% 
  select(VNMP, MinutiComparto, MinutiDirigente) %>% 
  group_by(VNMP) %>% 
  summarise(mincomp = mean(MinutiComparto, na.rm = TRUE), 
            mindir = mean(MinutiDirigente, na.rm = TRUE))), by = "VNMP") %>% 
    mutate(tesami = esami*mincomp) %>%
    filter(REPARTO == "sede territoriale di bergamo"  & 
             as.Date(dtreg) == as.Date("2019-01-07")) %>% 
    select(VNMP, "prova_singola" = provasingola, "prova_gruppi" = provagruppi, esami, 
           "tempo_esame" = mincomp, "tempo_analisi" = tesami) %>% 
 head(10) %>% 
   kable() %>% 
   kable_styling(full_width = F, bootstrap_options = c("striped", "hover", "condensed"))
 
```


<!-- ```{r echo=FALSE, message=FALSE, warning=FALSE} -->
<!-- esami2 <- read_excel(here("programmazione", "data", "raw", "dati2019.xlsx")) -->
<!-- esami2$MMPP <- substr(esami2$mp, start=1, stop = 9) -->
<!-- esami2$VNMP <- paste(esami2$vn, esami2$MMPP, esami2$revmp) # <- creo chiave simile a tempi$VNMP per fare collegamento tra esami e tempi -->

<!-- esami2$REPARTO <- tolower(esami2$Reparto) -->

<!-- esami2 <- esami2 %>%  -->
<!--   mutate(REPARTO = recode(REPARTO, "sede territoriale di milano (is)" = "sede territoriale di milano",  -->
<!--                           "reparto tecnologie biologiche applicate - batteriologia specializzata" = "reparto tecnologie biologiche applicate",  -->
<!--                           "reparto tecnologie biologiche applicate - colture cellulari" = "reparto tecnologie biologiche applicate",  -->
<!--                           "reparto virologia - laboratorio proteomica" = "reparto virologia",  -->
<!--                           )) %>%  -->
<!--   filter(!REPARTO %in% c("analisi del rischio ed epidemiologia genomica", -->
<!--                          "reparto produzione e controllo materiale biologico")) -->

<!--  options(knitr.kable.NA = '') -->
<!-- esami2 %>%  -->
<!--     left_join((tempi %>%  -->
<!--   select(VNMP, MinutiComparto, MinutiDirigente) %>%  -->
<!--   group_by(VNMP) %>%  -->
<!--   summarise(mincomp = mean(MinutiComparto, na.rm = TRUE),  -->
<!--             mindir = mean(MinutiDirigente, na.rm = TRUE))), by = "VNMP") %>%  -->
<!--     mutate(tesami = esami*mincomp) %>% -->
<!--     filter(REPARTO == "bologna (reparto chimico degli alimenti)" &  -->
<!--              as.Date(dtreg) == as.Date("2019-01-25")) %>% -->
<!--     select(VNMP, "prova_singola" = provasingola, "prova_gruppi" = provagruppi, esami,  -->
<!--            "tempo_esame" = mincomp, "tempo_analisi" = tesami) %>%  -->
<!--   View() -->
<!--   top_n(20) %>%  -->
<!--    kable() %>%  -->
<!--    kable_styling(full_width = F, bootstrap_options = c("striped", "hover", "condensed")) -->

<!-- ``` -->



<!-- ```{r echo=FALSE, message=FALSE, warning=FALSE} -->

<!-- options(knitr.kable.NA = '') -->

<!--  gruppi %>%  -->
<!--   filter(REPARTO == "sede territoriale di bergamo") %>%  -->
<!--   group_by(REPARTO, VNMP, `Prova - Gruppi`, -->
<!--           dtreg = `Data di registrazione`) %>%  -->
<!--   summarise(esami = n()) %>%  -->
<!--    top_n(5) %>%  -->
<!--    kable() %>%  -->
<!--    kable_styling(full_width = F, bootstrap_options = c("striped", "hover", "condensed")) -->


<!--  gruppi %>%  -->
<!--   filter(REPARTO == "sede territoriale di bergamo") %>%  -->
<!--   group_by(REPARTO, VNMP, `Prova - Gruppi`) %>%  -->
<!--   summarise(esami = n()) %>%  -->
<!--    kable() %>%  -->
<!--    kable_styling(full_width = F, bootstrap_options = c("striped", "hover", "condensed")) -->

<!-- ``` -->



### Tempi-analisi per Reparto

```{r echo=FALSE, message=FALSE, warning=FALSE}

options(knitr.kable.NA = '')
t <- tempi %>% 
  select(VNMP, MinutiComparto, MinutiDirigente) %>% 
  group_by(VNMP) %>% 
  summarise(mincomp = mean(MinutiComparto, na.rm = TRUE), 
            mindir = mean(MinutiDirigente, na.rm = TRUE)) 
##########################################################
Esami %>% 
  left_join(t, by = "VNMP") %>% 
  mutate(tesami = esami*mincomp) %>% 
  group_by(REPARTO) %>% 
  summarise(nesami = sum(esami, na.rm = T),
            tesami = sum(tesami, na.rm = T)/60) %>% 
  left_join(
    (hwd19 %>% 
      group_by(Dipartimento, REPARTO) %>% 
      summarise(hworked = sum(hworked), 
                hprev = sum(hprev))),
    by = "REPARTO") %>% 
  rename(Laboratorio = REPARTO )%>% 
  mutate(REPARTO = recode(Laboratorio, "sede territoriale di bergamo" = "sede territoriale di BG-VA-SO",
                           "sede territoriale di binago" = "sede territoriale di BG-VA-SO" ,
                         "sede territoriale di sondrio" = "sede territoriale di BG-VA-SO", 
                         "sede territoriale di cremona" = "sede territoriale di CR-MN",
                         "sede territoriale di mantova" = "sede territoriale di CR-MN",
                         "sede territoriale di lodi" = "sede territoriale di LO-MI",
                         "sede territoriale di milano" = "sede territoriale di LO-MI",
                         "sede territoriale di pavia" = "sede territoriale di PV",
                         "sede territoriale di brescia" = "sede territoriale di BS",
                         "sede territoriale di bologna" = "sede territoriale di BO-MO-FE",
                         "sede territoriale di modena" = "sede territoriale di BO-MO-FE",
                         "sede territoriale di ferrara" = "sede territoriale di BO-MO-FE",
                         "sede territoriale di forlì" = "sede territoriale di FO-RA",
                         "sede territoriale di ravenna" = "sede territoriale di FO-RA",
                         "sede territoriale di piacenza" = "sede territoriale di PC-PR",
                         "sede territoriale di parma" = "sede territoriale di PC-PR",
                         "sede territoriale di reggio emilia" = "sede territoriale di RE",
                         )) %>% 
  group_by(Dipartimento, REPARTO) %>% 
  summarise(nesami = sum(nesami, na.rm = T),
            tesami = sum(tesami, na.rm = T),
    hworked = sum(hworked), 
                hprev = sum(hprev)) %>% 
  mutate(FTE_previsto = hprev/1641.6, 
         FTE_reale = hworked/1641.6, 
         FTE_necessari = tesami/1641.6,
         perctana= 100*(tesami/hworked), 
         "%hworked" = 100*(hworked/hprev)) %>% 
  select(Dipartimento, Reparto = REPARTO, "N. analisi" = nesami, "tempo analisi (h)" = tesami, "ore lavorate"= hworked, "ore disponibili" = hprev, "% tempi analisi su h lavorate" = perctana, "% h worked" = "%hworked",
         FTE_previsto, FTE_reale, FTE_necessari) %>% 
  
  arrange(desc(Dipartimento)) %>% 
   kable() %>% 
   kable_styling(full_width = F, bootstrap_options = c("striped", "hover", "condensed")) %>% 
  collapse_rows(columns = 1, valign = "top")


```


### Tempi-esame per Reparto

```{r echo=FALSE, message=FALSE, warning=FALSE}

esami <- read_excel(here("programmazione", "data", "raw",  "dati2019.xlsx"))
esami$MMPP <- substr(esami$mp, start=1, stop = 9)
esami$VNMP <- ifelse(!is.na(esami$vngruppo), paste(esami$vngruppo, esami$MMPP, esami$revmp), paste(esami$vn, esami$MMPP, esami$revmp)) # <- creo chiave simile a tempi$VNMP per fare collegamento tra esami e tempi
esami$REPARTO <- tolower(esami$Reparto)

esami <- esami %>% 
  mutate(REPARTO = recode(REPARTO, "sede territoriale di milano (is)" = "sede territoriale di milano", 
                          "reparto tecnologie biologiche applicate - batteriologia specializzata" = "reparto tecnologie biologiche applicate", 
                          "reparto tecnologie biologiche applicate - colture cellulari" = "reparto tecnologie biologiche applicate", 
                          "reparto virologia - laboratorio proteomica" = "reparto virologia", 
  )) %>% 
  filter(!REPARTO %in% c("analisi del rischio ed epidemiologia genomica",
                         "reparto produzione e controllo materiale biologico"))



t <- tempi %>%
  select(VNMP, MinutiComparto, MinutiDirigente) %>%
  group_by(VNMP) %>%
  summarise(mincomp = mean(MinutiComparto, na.rm = TRUE),
            mindir = mean(MinutiDirigente, na.rm = TRUE))
esami %>% 
  left_join(t, by = "VNMP") %>% 
  mutate(tesami = esami*mincomp) %>% 
  group_by(REPARTO) %>% 
  summarise(nesami = sum(esami, na.rm = T),
            tesami = sum(tesami, na.rm = T)/60) %>% 
  left_join(
    (hwd19 %>% 
       group_by(Dipartimento, REPARTO) %>% 
       summarise(hworked = sum(hworked), 
                 hprev = sum(hprev))),
    by = "REPARTO") %>% 
  rename(Laboratorio = REPARTO )%>% 
  mutate(REPARTO = recode(Laboratorio, "sede territoriale di bergamo" = "sede territoriale di BG-VA-SO",
                           "sede territoriale di binago" = "sede territoriale di BG-VA-SO" ,
                         "sede territoriale di sondrio" = "sede territoriale di BG-VA-SO", 
                         "sede territoriale di cremona" = "sede territoriale di CR-MN",
                         "sede territoriale di mantova" = "sede territoriale di CR-MN",
                         "sede territoriale di lodi" = "sede territoriale di LO-MI",
                         "sede territoriale di milano" = "sede territoriale di LO-MI",
                         "sede territoriale di pavia" = "sede territoriale di PV",
                         "sede territoriale di brescia" = "sede territoriale di BS",
                         "sede territoriale di bologna" = "sede territoriale di BO-MO-FE",
                         "sede territoriale di modena" = "sede territoriale di BO-MO-FE",
                         "sede territoriale di ferrara" = "sede territoriale di BO-MO-FE",
                         "sede territoriale di forlì" = "sede territoriale di FO-RA",
                         "sede territoriale di ravenna" = "sede territoriale di FO-RA",
                         "sede territoriale di piacenza" = "sede territoriale di PC-PR",
                         "sede territoriale di parma" = "sede territoriale di PC-PR",
                         "sede territoriale di reggio emilia" = "sede territoriale di RE",
                         )) %>% 
  group_by(Dipartimento, REPARTO) %>% 
  summarise(nesami = sum(nesami, na.rm = T),
            tesami = sum(tesami, na.rm = T),
    hworked = sum(hworked), 
                hprev = sum(hprev)) %>% 
  mutate(FTE_previsto = hprev/1641.6, 
         FTE_reale = hworked/1641.6, 
         FTE_necessari = tesami/1641.6,
         perctana= 100*(tesami/hworked), 
         "%hworked" = 100*(hworked/hprev)) %>% 
  select(Dipartimento, Reparto = REPARTO, "N. analisi" = nesami, "tempo analisi (h)" = tesami, "ore lavorate"= hworked, "ore disponibili" = hprev, "% tempi analisi su h lavorate" = perctana, "% h worked" = "%hworked",
         FTE_previsto, FTE_reale, FTE_necessari) %>% 
  arrange(desc(Dipartimento)) %>% 
   kable() %>% 
   kable_styling(full_width = F, bootstrap_options = c("striped", "hover", "condensed")) %>% 
  collapse_rows(columns = 1, valign = "top")

```


  
